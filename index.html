<!DOCTYPE HTML>
<html>
    <head>
        <style>
            body {
                margin: 0px;
                padding: 0px;
            }
        </style>

        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body data-rsssl=1>
        <canvas id="myCanvas" width="700" height="400"></canvas>

        <script src = "script.js"></script>
        <script src = "interpreter.js"></script>

        <input type="text" id="var-name">
        <br />
        <input type="text"   id="list-size" size="1">
        <input type="submit" id="new-cons" value="+">
        <input type="submit" id="remove-cons" value="-">
        <input type="submit" id="new-connect" value="->">
        <br />
        <br />
        <input type="submit" id="compile" value="compile">
        <br />
        <textarea id="lisp-code"></textarea>
        <textarea id="debug"></textarea>
        <br />

        <h3>Context</h3>
        <br />
        <ul id="context">
        </ul>

        <script>
            const width  = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            const height = window.innerHeight|| document.documentElement.clientHeight|| document.body.clientHeight;
            const UI_height = height / 3;

            let canvas = document.getElementById('myCanvas');
            canvas.width = width;
            canvas.height = height - UI_height;
            let ctx = canvas.getContext('2d');

            let cells = [
                newList(10, 100, ['lambda', 'x', 'x']),
                newList(10, 50, ['+', 'x', '2']),
            ];

            let scene = new Scene(canvas, ctx, cells);

            // A repl context for our definitions
            //let context = {};
            let global_env = std_env();


            document.getElementById('var-name').onkeyup = () => {
                scene.setCellValue( document.getElementById('var-name').value );
            };

            document.getElementById('compile').onclick = () => {
                let src_cell = scene.context[ scene.selected[0] ];
                let cons_list = cells.filter( c => c.type == 'list');

                // Side effects in modifying context
                //let code_str = compile(src_cell, cons_list, context);

                const result = eval(
                    parseCells(src_cell.elems, {...new Env(), ...scene.context}),
                    global_env);

                // Output evaluation
                document.getElementById('lisp-code').value = result;

                // Re-print the context
                const ul = document.getElementById('context');
                //for (let [k,v] of Object.entries( context )) {
                Object.keys(global_env).forEach( k => {
                    const li = document.createElement('li');
                    li.appendChild( document.createTextNode(k) );
                    li.onclick = () => {
                    };
                    ul.appendChild( li );
                });
            };

            document.getElementById('new-connect').onclick = () => { scene.connecting = true; };
            document.getElementById('new-cons').onclick = () => {
                let size = parseInt( document.getElementById('list-size').value );
                let l = Array.apply(null, Array(size)).map( _ => '');
                scene.addList(10,10, l);
            }
            document.getElementById('remove-cons').onclick = () => {
                scene.removeCell( scene.selected[0] );
            }

            // listen for mouse events
            canvas.onmousedown = scene.mouseDownEvent;
            canvas.onmouseup = scene.mouseUpEvent;
            canvas.onmousemove = scene.mouseMoveEvent;

            canvas.addEventListener('touchstart', scene.touchDownEvent);
            canvas.addEventListener('touchend', scene.touchUpEvent);
            canvas.addEventListener('touchmove', scene.touchMoveEvent);

            // call to draw the scene initially
            scene.draw();
        </script>
    </body>
</html>
